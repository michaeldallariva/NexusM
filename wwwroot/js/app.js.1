// ═══════════════════════════════════════════════════════════
// NexusM - Client-Side Application
// Single Page Application with audio player
// ═══════════════════════════════════════════════════════════

const App = {
    currentPage: 'home',
    audioPlayer: null,
    currentTrack: null,
    playlist: [],       // current play queue
    playIndex: -1,
    isPlaying: false,
    shuffle: false,
    repeat: 'off',      // off, all, one

    // ─── Init ────────────────────────────────────────────────
    init() {
        this.audioPlayer = document.getElementById('audio-player');
        this.bindNavigation();
        this.bindPlayer();
        this.bindSearch();
        this.bindToolbar();
        this.navigate('home');
    },

    // ─── API Helpers ─────────────────────────────────────────
    async api(endpoint) {
        try {
            const res = await fetch(`/api/${endpoint}`);
            if (!res.ok) throw new Error(`HTTP ${res.status}`);
            return await res.json();
        } catch (err) {
            console.error(`API error [${endpoint}]:`, err);
            return null;
        }
    },

    async apiPost(endpoint, body = {}) {
        try {
            const res = await fetch(`/api/${endpoint}`, {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify(body)
            });
            return await res.json();
        } catch (err) {
            console.error(`API POST error [${endpoint}]:`, err);
            return null;
        }
    },

    // ─── Navigation ──────────────────────────────────────────
    bindNavigation() {
        document.querySelectorAll('.sidebar-nav a[data-page]').forEach(link => {
            link.addEventListener('click', (e) => {
                e.preventDefault();
                this.navigate(link.dataset.page);
            });
        });
    },

    navigate(page) {
        this.currentPage = page;
        // Update sidebar active state
        document.querySelectorAll('.sidebar-nav a').forEach(a => a.classList.remove('active'));
        const activeLink = document.querySelector(`a[data-page="${page}"]`);
        if (activeLink) activeLink.classList.add('active');

        // Update breadcrumb
        const titles = {
            home: 'Home', albums: 'Albums', artists: 'Artists', songs: 'Songs',
            genres: 'Genres', favourites: 'Favourites', playlists: 'Playlists',
            recent: 'Recently Added', mostplayed: 'Most Played', settings: 'Settings'
        };
        document.getElementById('page-title').innerHTML = `<span>${titles[page] || page}</span>`;

        // Render page
        this.renderPage(page);
    },

    async renderPage(page) {
        const content = document.getElementById('main-content');
        content.innerHTML = '<div class="spinner"></div>';

        switch (page) {
            case 'home':     await this.renderHome(content); break;
            case 'albums':   await this.renderAlbums(content); break;
            case 'artists':  await this.renderArtists(content); break;
            case 'songs':    await this.renderSongs(content); break;
            case 'genres':   await this.renderGenres(content); break;
            case 'favourites': await this.renderFavourites(content); break;
            case 'playlists': await this.renderPlaylists(content); break;
            case 'recent':   await this.renderRecent(content); break;
            case 'mostplayed': await this.renderMostPlayed(content); break;
            case 'settings': await this.renderSettings(content); break;
            default:         content.innerHTML = '<div class="empty-state"><h2>Page not found</h2></div>';
        }
    },

    // ─── Home Page ───────────────────────────────────────────
    async renderHome(el) {
        const stats = await this.api('stats');
        const recent = await this.api('tracks/recent?limit=10');

        let html = '<div class="page-header"><h1>Home</h1></div>';

        if (stats) {
            html += `<div class="stats-grid">
                <div class="stat-card"><div class="stat-value">${stats.totalTracks}</div><div class="stat-label">Tracks</div></div>
                <div class="stat-card"><div class="stat-value">${stats.totalAlbums}</div><div class="stat-label">Albums</div></div>
                <div class="stat-card"><div class="stat-value">${stats.totalArtists}</div><div class="stat-label">Artists</div></div>
                <div class="stat-card"><div class="stat-value">${stats.totalPlaylists}</div><div class="stat-label">Playlists</div></div>
                <div class="stat-card"><div class="stat-value">${stats.genres}</div><div class="stat-label">Genres</div></div>
                <div class="stat-card"><div class="stat-value">${this.formatSize(stats.totalSize)}</div><div class="stat-label">Total Size</div></div>
            </div>`;
        }

        if (stats && stats.totalTracks === 0) {
            html += `<div class="empty-state">
                <div class="empty-icon">&#127925;</div>
                <h2>Welcome to NexusM</h2>
                <p>Your music library is empty. Configure your music folders in NexusM.conf, then click the scan button to index your collection.</p>
                <button class="btn-primary" onclick="App.startScan()">Scan Library</button>
            </div>`;
        } else if (recent && recent.length > 0) {
            html += '<div class="section-title">Recently Added</div>';
            html += this.renderTrackTable(recent);
        }

        el.innerHTML = html;
    },

    // ─── Albums Page ─────────────────────────────────────────
    async renderAlbums(el) {
        const data = await this.api('albums?limit=100&sort=recent');
        let html = `<div class="page-header"><h1>Albums</h1>
            <div class="filter-bar">
                <button class="filter-chip active" onclick="App.loadAlbums('recent')">Recent</button>
                <button class="filter-chip" onclick="App.loadAlbums('name')">A-Z</button>
                <button class="filter-chip" onclick="App.loadAlbums('artist')">Artist</button>
                <button class="filter-chip" onclick="App.loadAlbums('year')">Year</button>
            </div>
        </div>`;

        if (data && data.albums && data.albums.length > 0) {
            html += '<div class="card-grid">';
            data.albums.forEach(album => {
                html += `<div class="card" onclick="App.openAlbum(${album.id})">
                    <div class="card-cover">
                        <img src="/api/cover/${album.id}" onerror="this.style.display='none';this.parentElement.innerHTML='<div class=placeholder-icon>&#128191;</div>'" alt="">
                        <button class="card-play-btn" onclick="event.stopPropagation(); App.playAlbum(${album.id})">&#9654;</button>
                    </div>
                    <div class="card-info">
                        <div class="card-title">${this.esc(album.name)}</div>
                        <div class="card-subtitle">${this.esc(album.artist)}${album.year ? ' &middot; ' + album.year : ''}</div>
                    </div>
                </div>`;
            });
            html += '</div>';
        } else {
            html += this.emptyState('No albums found', 'Scan your music library to discover albums.');
        }

        el.innerHTML = html;
    },

    async loadAlbums(sort) {
        document.querySelectorAll('.filter-chip').forEach(c => c.classList.remove('active'));
        event.target.classList.add('active');
        const data = await this.api(`albums?limit=100&sort=${sort}`);
        const grid = document.querySelector('.card-grid');
        if (!grid || !data) return;
        let html = '';
        data.albums.forEach(album => {
            html += `<div class="card" onclick="App.openAlbum(${album.id})">
                <div class="card-cover">
                    <img src="/api/cover/${album.id}" onerror="this.style.display='none';this.parentElement.innerHTML='<div class=placeholder-icon>&#128191;</div>'" alt="">
                    <button class="card-play-btn" onclick="event.stopPropagation(); App.playAlbum(${album.id})">&#9654;</button>
                </div>
                <div class="card-info">
                    <div class="card-title">${this.esc(album.name)}</div>
                    <div class="card-subtitle">${this.esc(album.artist)}${album.year ? ' &middot; ' + album.year : ''}</div>
                </div>
            </div>`;
        });
        grid.innerHTML = html;
    },

    async openAlbum(id) {
        const album = await this.api(`albums/${id}`);
        if (!album) return;
        const el = document.getElementById('main-content');
        document.getElementById('page-title').innerHTML = `<span>${this.esc(album.name)}</span>`;

        let html = `<div class="page-header">
            <div>
                <h1>${this.esc(album.name)}</h1>
                <div style="color:var(--text-secondary);font-size:14px;margin-top:4px">
                    ${this.esc(album.artist)}${album.year ? ' &middot; ' + album.year : ''} &middot;
                    ${album.tracks ? album.tracks.length : 0} tracks &middot;
                    ${this.formatDuration(album.totalDuration)}
                </div>
            </div>
            <button class="btn-primary" onclick="App.playAlbum(${album.id})">&#9654; Play All</button>
        </div>`;

        if (album.tracks && album.tracks.length > 0) {
            html += this.renderTrackTable(album.tracks, true);
        }

        el.innerHTML = html;
    },

    async playAlbum(id) {
        const album = await this.api(`albums/${id}`);
        if (!album || !album.tracks) return;
        this.playlist = album.tracks;
        this.playIndex = 0;
        this.playTrack(this.playlist[0]);
    },

    // ─── Artists Page ────────────────────────────────────────
    async renderArtists(el) {
        const data = await this.api('artists?limit=100');
        let html = '<div class="page-header"><h1>Artists</h1></div>';

        if (data && data.artists && data.artists.length > 0) {
            html += '<div class="card-grid">';
            data.artists.forEach(artist => {
                html += `<div class="card" onclick="App.openArtist(${artist.id})">
                    <div class="card-cover"><div class="placeholder-icon">&#127908;</div></div>
                    <div class="card-info">
                        <div class="card-title">${this.esc(artist.name)}</div>
                        <div class="card-subtitle">${artist.albumCount || 0} albums &middot; ${artist.trackCount || 0} tracks</div>
                    </div>
                </div>`;
            });
            html += '</div>';
        } else {
            html += this.emptyState('No artists found', 'Scan your music library to discover artists.');
        }
        el.innerHTML = html;
    },

    async openArtist(id) {
        const data = await this.api(`artists/${id}`);
        if (!data) return;
        const el = document.getElementById('main-content');
        document.getElementById('page-title').innerHTML = `<span>${this.esc(data.artist.name)}</span>`;

        let html = `<div class="page-header"><h1>${this.esc(data.artist.name)}</h1></div>`;
        if (data.albums && data.albums.length > 0) {
            html += '<div class="card-grid">';
            data.albums.forEach(album => {
                html += `<div class="card" onclick="App.openAlbum(${album.id})">
                    <div class="card-cover">
                        <img src="/api/cover/${album.id}" onerror="this.style.display='none';this.parentElement.innerHTML='<div class=placeholder-icon>&#128191;</div>'" alt="">
                        <button class="card-play-btn" onclick="event.stopPropagation(); App.playAlbum(${album.id})">&#9654;</button>
                    </div>
                    <div class="card-info">
                        <div class="card-title">${this.esc(album.name)}</div>
                        <div class="card-subtitle">${album.year || ''}</div>
                    </div>
                </div>`;
            });
            html += '</div>';
        }
        el.innerHTML = html;
    },

    // ─── Songs Page ──────────────────────────────────────────
    async renderSongs(el) {
        const data = await this.api('tracks?limit=100&sort=title');
        let html = `<div class="page-header"><h1>Songs</h1>
            <div class="filter-bar">
                <button class="filter-chip active" onclick="App.loadSongs('title')">A-Z</button>
                <button class="filter-chip" onclick="App.loadSongs('artist')">Artist</button>
                <button class="filter-chip" onclick="App.loadSongs('album')">Album</button>
                <button class="filter-chip" onclick="App.loadSongs('recent')">Recent</button>
            </div>
        </div>`;

        if (data && data.tracks && data.tracks.length > 0) {
            html += this.renderTrackTable(data.tracks);
        } else {
            html += this.emptyState('No songs found', 'Scan your music library to see all your songs.');
        }
        el.innerHTML = html;
    },

    async loadSongs(sort) {
        document.querySelectorAll('.filter-chip').forEach(c => c.classList.remove('active'));
        event.target.classList.add('active');
        const data = await this.api(`tracks?limit=100&sort=${sort}`);
        const table = document.querySelector('.track-list');
        if (!table || !data) return;
        table.querySelector('tbody').innerHTML = this.renderTrackRows(data.tracks);
    },

    // ─── Genres Page ─────────────────────────────────────────
    async renderGenres(el) {
        const genres = await this.api('genres');
        let html = '<div class="page-header"><h1>Genres</h1></div>';
        if (genres && genres.length > 0) {
            html += '<div class="genre-grid">';
            genres.forEach(g => {
                html += `<div class="genre-tag" onclick="App.openGenre('${this.esc(g.name)}')">
                    ${this.esc(g.name)}<span class="genre-count">${g.count}</span>
                </div>`;
            });
            html += '</div>';
        } else {
            html += this.emptyState('No genres found', 'Genre data is extracted from your music file tags.');
        }
        el.innerHTML = html;
    },

    async openGenre(genre) {
        const data = await this.api(`tracks?genre=${encodeURIComponent(genre)}&limit=100`);
        const el = document.getElementById('main-content');
        document.getElementById('page-title').innerHTML = `<span>Genre: ${this.esc(genre)}</span>`;
        let html = `<div class="page-header"><h1>${this.esc(genre)}</h1></div>`;
        if (data && data.tracks && data.tracks.length > 0) {
            html += this.renderTrackTable(data.tracks);
        }
        el.innerHTML = html;
    },

    // ─── Favourites ──────────────────────────────────────────
    async renderFavourites(el) {
        const data = await this.api('tracks/favourites?limit=100');
        let html = '<div class="page-header"><h1>Favourites</h1></div>';
        if (data && data.tracks && data.tracks.length > 0) {
            html += this.renderTrackTable(data.tracks);
        } else {
            html += this.emptyState('No favourites yet', 'Click the heart icon on any track to add it to your favourites.');
        }
        el.innerHTML = html;
    },

    // ─── Playlists ───────────────────────────────────────────
    async renderPlaylists(el) {
        const playlists = await this.api('playlists');
        let html = `<div class="page-header"><h1>Playlists</h1>
            <button class="btn-primary" onclick="App.createPlaylist()">+ New Playlist</button>
        </div>`;
        if (playlists && playlists.length > 0) {
            html += '<div class="card-grid">';
            playlists.forEach(p => {
                html += `<div class="card" onclick="App.openPlaylist(${p.id})">
                    <div class="card-cover"><div class="placeholder-icon">&#128220;</div></div>
                    <div class="card-info">
                        <div class="card-title">${this.esc(p.name)}</div>
                        <div class="card-subtitle">${p.trackCount} tracks</div>
                    </div>
                </div>`;
            });
            html += '</div>';
        } else {
            html += this.emptyState('No playlists yet', 'Create your first playlist to organize your music.');
        }
        el.innerHTML = html;
    },

    async createPlaylist() {
        const name = prompt('Enter playlist name:');
        if (!name) return;
        await this.apiPost('playlists', { name, description: '' });
        this.renderPage('playlists');
    },

    async openPlaylist(id) {
        const data = await this.api(`playlists/${id}`);
        if (!data) return;
        const el = document.getElementById('main-content');
        document.getElementById('page-title').innerHTML = `<span>${this.esc(data.name)}</span>`;
        let html = `<div class="page-header"><h1>${this.esc(data.name)}</h1></div>`;
        if (data.playlistTracks && data.playlistTracks.length > 0) {
            const tracks = data.playlistTracks.map(pt => pt.track).filter(Boolean);
            html += this.renderTrackTable(tracks);
        } else {
            html += this.emptyState('Empty playlist', 'Add tracks from the Songs page.');
        }
        el.innerHTML = html;
    },

    // ─── Recently Added ──────────────────────────────────────
    async renderRecent(el) {
        const tracks = await this.api('tracks/recent?limit=50');
        let html = '<div class="page-header"><h1>Recently Added</h1></div>';
        if (tracks && tracks.length > 0) {
            html += this.renderTrackTable(tracks);
        } else {
            html += this.emptyState('Nothing here yet', 'Scan your music library to populate this page.');
        }
        el.innerHTML = html;
    },

    // ─── Most Played ─────────────────────────────────────────
    async renderMostPlayed(el) {
        const tracks = await this.api('tracks/mostplayed?limit=50');
        let html = '<div class="page-header"><h1>Most Played</h1></div>';
        if (tracks && tracks.length > 0) {
            html += this.renderTrackTable(tracks);
        } else {
            html += this.emptyState('Nothing played yet', 'Start listening to see your most played tracks.');
        }
        el.innerHTML = html;
    },

    // ─── Settings Page ───────────────────────────────────────
    async renderSettings(el) {
        const config = await this.api('config/info');
        const stats = await this.api('stats');

        let html = '<div class="page-header"><h1>Settings</h1></div>';

        html += '<div class="settings-section"><h3>Server Information</h3>';
        if (config) {
            html += `
                <div class="setting-row"><span class="setting-label">Application</span><span class="setting-value">${config.appName}</span></div>
                <div class="setting-row"><span class="setting-label">Config File</span><span class="setting-value">${config.configFile}</span></div>
                <div class="setting-row"><span class="setting-label">Theme</span><span class="setting-value">${config.theme}</span></div>
                <div class="setting-row"><span class="setting-label">Default View</span><span class="setting-value">${config.defaultView}</span></div>
                <div class="setting-row"><span class="setting-label">Transcoding</span><span class="setting-value">${config.transcodingEnabled ? 'Enabled' : 'Disabled'}</span></div>
            `;
        }
        html += '</div>';

        html += '<div class="settings-section"><h3>Music Folders</h3>';
        if (config && config.musicFolders && config.musicFolders.length > 0) {
            config.musicFolders.forEach(f => {
                html += `<div class="setting-row"><span class="setting-label">${this.esc(f)}</span></div>`;
            });
        } else {
            html += '<div class="setting-row"><span class="setting-label" style="color:var(--text-muted)">No music folders configured. Edit NexusM.conf</span></div>';
        }
        html += '</div>';

        html += '<div class="settings-section"><h3>Library Scan</h3>';
        html += `<button class="btn-primary" onclick="App.startScan()">&#128472; Scan Library Now</button>
                 <div id="scan-status" style="margin-top:12px"></div>`;
        html += '</div>';

        if (stats) {
            html += '<div class="settings-section"><h3>Library Statistics</h3>';
            html += `
                <div class="setting-row"><span class="setting-label">Total Tracks</span><span class="setting-value">${stats.totalTracks}</span></div>
                <div class="setting-row"><span class="setting-label">Total Albums</span><span class="setting-value">${stats.totalAlbums}</span></div>
                <div class="setting-row"><span class="setting-label">Total Artists</span><span class="setting-value">${stats.totalArtists}</span></div>
                <div class="setting-row"><span class="setting-label">Total Size</span><span class="setting-value">${this.formatSize(stats.totalSize)}</span></div>
                <div class="setting-row"><span class="setting-label">Total Duration</span><span class="setting-value">${this.formatDuration(stats.totalDuration)}</span></div>
            `;
            html += '</div>';
        }

        el.innerHTML = html;
    },

    // ─── Library Scan ────────────────────────────────────────
    async startScan() {
        const result = await this.apiPost('scan');
        if (result) {
            this.pollScanStatus();
        }
    },

    async pollScanStatus() {
        const statusEl = document.getElementById('scan-status');
        const poll = async () => {
            const s = await this.api('scan/status');
            if (!s || !statusEl) return;
            if (s.isScanning) {
                statusEl.innerHTML = `<div class="scan-bar">
                    <div class="scan-text">Scanning... ${s.processedFiles}/${s.totalFiles} files (${s.percentComplete}%)</div>
                    <div class="scan-progress"><div class="scan-progress-fill" style="width:${s.percentComplete}%"></div></div>
                </div>`;
                setTimeout(poll, 1000);
            } else {
                statusEl.innerHTML = `<div class="scan-bar">
                    <div class="scan-text">${s.message || 'Scan complete'}</div>
                </div>`;
            }
        };
        poll();
    },

    // ─── Track Table Renderer ────────────────────────────────
    renderTrackTable(tracks, showTrackNum = false) {
        let html = `<table class="track-list"><thead><tr>
            ${showTrackNum ? '<th class="track-number">#</th>' : '<th class="track-number"></th>'}
            <th>Title</th><th>Artist</th><th>Album</th><th class="track-duration">Duration</th>
            <th class="track-actions"></th>
        </tr></thead><tbody>${this.renderTrackRows(tracks, showTrackNum)}</tbody></table>`;
        return html;
    },

    renderTrackRows(tracks, showTrackNum = false) {
        if (!tracks) return '';
        return tracks.map((t, i) => {
            const dur = this.formatDuration(t.duration);
            const num = showTrackNum ? (t.trackNumber || i + 1) : (i + 1);
            const favClass = t.isFavourite ? 'active' : '';
            return `<tr onclick="App.playFromList(${i})" data-track-id="${t.id}">
                <td class="track-number">${num}</td>
                <td class="track-title">${this.esc(t.title)}</td>
                <td>${this.esc(t.artist)}</td>
                <td>${this.esc(t.album)}</td>
                <td class="track-duration">${dur}</td>
                <td class="track-actions">
                    <button class="track-fav-btn ${favClass}" onclick="event.stopPropagation(); App.toggleFav(${t.id}, this)">&#10084;</button>
                </td>
            </tr>`;
        }).join('');
    },

    // ─── Audio Player ────────────────────────────────────────
    bindPlayer() {
        const audio = this.audioPlayer;

        document.getElementById('btn-play').addEventListener('click', () => this.togglePlay());
        document.getElementById('btn-prev').addEventListener('click', () => this.prevTrack());
        document.getElementById('btn-next').addEventListener('click', () => this.nextTrack());
        document.getElementById('btn-shuffle').addEventListener('click', () => {
            this.shuffle = !this.shuffle;
            document.getElementById('btn-shuffle').style.color = this.shuffle ? 'var(--accent)' : '';
        });
        document.getElementById('btn-repeat').addEventListener('click', () => {
            const modes = ['off', 'all', 'one'];
            this.repeat = modes[(modes.indexOf(this.repeat) + 1) % 3];
            const btn = document.getElementById('btn-repeat');
            btn.style.color = this.repeat !== 'off' ? 'var(--accent)' : '';
            btn.title = `Repeat: ${this.repeat}`;
        });

        // Volume
        document.getElementById('volume-slider').addEventListener('input', (e) => {
            audio.volume = e.target.value / 100;
        });
        audio.volume = 0.8;

        // Progress bar click
        document.getElementById('progress-bar').addEventListener('click', (e) => {
            const rect = e.currentTarget.getBoundingClientRect();
            const pct = (e.clientX - rect.left) / rect.width;
            audio.currentTime = pct * audio.duration;
        });

        // Time update
        audio.addEventListener('timeupdate', () => {
            if (!audio.duration) return;
            const pct = (audio.currentTime / audio.duration) * 100;
            document.getElementById('progress-fill').style.width = pct + '%';
            document.getElementById('time-current').textContent = this.formatDuration(audio.currentTime);
            document.getElementById('time-total').textContent = this.formatDuration(audio.duration);
        });

        // Track ended
        audio.addEventListener('ended', () => {
            if (this.repeat === 'one') {
                audio.currentTime = 0;
                audio.play();
            } else {
                this.nextTrack();
            }
        });
    },

    playTrack(track) {
        if (!track) return;
        this.currentTrack = track;
        this.audioPlayer.src = `/api/stream/${track.id}`;
        this.audioPlayer.play();
        this.isPlaying = true;

        document.getElementById('btn-play').innerHTML = '&#9646;&#9646;';
        document.getElementById('player-title').textContent = track.title || 'Unknown';
        document.getElementById('player-artist').textContent = track.artist || '';

        // Update cover
        const coverDiv = document.getElementById('player-cover');
        if (track.hasAlbumArt) {
            coverDiv.innerHTML = `<img src="/api/cover/track/${track.id}" onerror="this.parentElement.innerHTML='<div style=\\'display:flex;align-items:center;justify-content:center;width:100%;height:100%;font-size:22px;color:#666\\'>&#9835;</div>'" alt="">`;
        } else {
            coverDiv.innerHTML = '<div style="display:flex;align-items:center;justify-content:center;width:100%;height:100%;font-size:22px;color:#666">&#9835;</div>';
        }

        // Highlight playing row
        document.querySelectorAll('.track-list tr.playing').forEach(r => r.classList.remove('playing'));
        const row = document.querySelector(`tr[data-track-id="${track.id}"]`);
        if (row) row.classList.add('playing');
    },

    playFromList(index) {
        // Collect current visible tracks as playlist
        const rows = document.querySelectorAll('.track-list tbody tr');
        if (rows.length > 0) {
            // Rebuild playlist from visible table
            this.playlist = Array.from(rows).map(row => {
                const id = parseInt(row.dataset.trackId);
                const cells = row.querySelectorAll('td');
                return {
                    id,
                    title: cells[1]?.textContent || '',
                    artist: cells[2]?.textContent || '',
                    album: cells[3]?.textContent || '',
                    hasAlbumArt: true // assume, will fallback
                };
            });
        }
        this.playIndex = index;
        if (this.playlist[index]) {
            this.playTrack(this.playlist[index]);
        }
    },

    togglePlay() {
        if (!this.audioPlayer.src) return;
        if (this.isPlaying) {
            this.audioPlayer.pause();
            this.isPlaying = false;
            document.getElementById('btn-play').innerHTML = '&#9654;';
        } else {
            this.audioPlayer.play();
            this.isPlaying = true;
            document.getElementById('btn-play').innerHTML = '&#9646;&#9646;';
        }
    },

    nextTrack() {
        if (this.playlist.length === 0) return;
        if (this.shuffle) {
            this.playIndex = Math.floor(Math.random() * this.playlist.length);
        } else {
            this.playIndex++;
            if (this.playIndex >= this.playlist.length) {
                if (this.repeat === 'all') this.playIndex = 0;
                else { this.playIndex = this.playlist.length - 1; return; }
            }
        }
        this.playTrack(this.playlist[this.playIndex]);
    },

    prevTrack() {
        if (this.playlist.length === 0) return;
        if (this.audioPlayer.currentTime > 3) {
            this.audioPlayer.currentTime = 0;
            return;
        }
        this.playIndex--;
        if (this.playIndex < 0) this.playIndex = this.repeat === 'all' ? this.playlist.length - 1 : 0;
        this.playTrack(this.playlist[this.playIndex]);
    },

    // ─── Favourites Toggle ───────────────────────────────────
    async toggleFav(trackId, btn) {
        const result = await this.apiPost(`tracks/${trackId}/favourite`);
        if (result) {
            btn.classList.toggle('active', result.isFavourite);
        }
    },

    // ─── Search ──────────────────────────────────────────────
    bindSearch() {
        let timeout;
        document.getElementById('global-search').addEventListener('input', (e) => {
            clearTimeout(timeout);
            const q = e.target.value.trim();
            if (q.length < 2) return;
            timeout = setTimeout(() => this.performSearch(q), 300);
        });
        document.getElementById('global-search').addEventListener('keypress', (e) => {
            if (e.key === 'Enter') {
                const q = e.target.value.trim();
                if (q.length >= 2) this.performSearch(q);
            }
        });
    },

    async performSearch(query) {
        const data = await this.api(`search?q=${encodeURIComponent(query)}`);
        if (!data) return;
        const el = document.getElementById('main-content');
        document.getElementById('page-title').innerHTML = `<span>Search: "${this.esc(query)}"</span>`;

        let html = `<div class="page-header"><h1>Search Results</h1></div>`;

        if (data.artists && data.artists.length > 0) {
            html += '<div class="section-title">Artists</div><div class="card-grid">';
            data.artists.forEach(a => {
                html += `<div class="card" onclick="App.openArtist(${a.id})">
                    <div class="card-cover"><div class="placeholder-icon">&#127908;</div></div>
                    <div class="card-info"><div class="card-title">${this.esc(a.name)}</div></div>
                </div>`;
            });
            html += '</div>';
        }

        if (data.albums && data.albums.length > 0) {
            html += '<div class="section-title">Albums</div><div class="card-grid">';
            data.albums.forEach(a => {
                html += `<div class="card" onclick="App.openAlbum(${a.id})">
                    <div class="card-cover">
                        <img src="/api/cover/${a.id}" onerror="this.style.display='none';this.parentElement.innerHTML='<div class=placeholder-icon>&#128191;</div>'" alt="">
                    </div>
                    <div class="card-info">
                        <div class="card-title">${this.esc(a.title)}</div>
                        <div class="card-subtitle">${this.esc(a.artist)}</div>
                    </div>
                </div>`;
            });
            html += '</div>';
        }

        if (data.tracks && data.tracks.length > 0) {
            html += '<div class="section-title">Tracks</div>';
            html += this.renderTrackTable(data.tracks);
        }

        if ((!data.tracks || data.tracks.length === 0) &&
            (!data.albums || data.albums.length === 0) &&
            (!data.artists || data.artists.length === 0)) {
            html += this.emptyState('No results', `Nothing found for "${this.esc(query)}".`);
        }

        el.innerHTML = html;
    },

    // ─── Toolbar ─────────────────────────────────────────────
    bindToolbar() {
        document.getElementById('btn-scan').addEventListener('click', () => this.startScan());
        document.getElementById('btn-refresh').addEventListener('click', () => this.renderPage(this.currentPage));
    },

    // ─── Helpers ─────────────────────────────────────────────
    formatDuration(seconds) {
        if (!seconds || isNaN(seconds)) return '0:00';
        const s = Math.floor(seconds);
        if (s >= 3600) {
            const h = Math.floor(s / 3600);
            const m = Math.floor((s % 3600) / 60);
            const sec = s % 60;
            return `${h}:${m.toString().padStart(2, '0')}:${sec.toString().padStart(2, '0')}`;
        }
        const m = Math.floor(s / 60);
        const sec = s % 60;
        return `${m}:${sec.toString().padStart(2, '0')}`;
    },

    formatSize(bytes) {
        if (!bytes) return '0 B';
        const units = ['B', 'KB', 'MB', 'GB', 'TB'];
        let i = 0;
        let size = bytes;
        while (size >= 1024 && i < units.length - 1) { size /= 1024; i++; }
        return `${size.toFixed(1)} ${units[i]}`;
    },

    esc(str) {
        if (!str) return '';
        const div = document.createElement('div');
        div.textContent = str;
        return div.innerHTML;
    },

    emptyState(title, message) {
        return `<div class="empty-state">
            <div class="empty-icon">&#127925;</div>
            <h2>${title}</h2>
            <p>${message}</p>
        </div>`;
    }
};

// Boot
document.addEventListener('DOMContentLoaded', () => App.init());
